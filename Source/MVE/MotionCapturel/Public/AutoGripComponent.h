/*⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⡰⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠴⠔⢄⣀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠂⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠓⢲⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⡜⠉⠀⠀⠀⠀⠐⠒⠒⠒⠒⡆⠀⢰⠒⠒⠒⠀⢰⠀⠀⠐⢂⠀⠀⡆⡆⠀⠀⠀⡔⠒⠒⢄⠀⠀⠀⠀⠈⢳⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⢰⠁⠀⠀⠀⠀⠀⠠⠤⢤⠤⠤⡇⠀⠸⠤⠤⠤⢄⢸⠀⠈⠩⢅⡉⠈⡆⡇⠀⠀⠑⢄⢀⢀⠌⠂⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⢽⠀⠤⠃⠀⠀⡠⠤⠤⠤⢪⠀⠀⡇⠀⡇⢀⠏⡇⠀⠀⢐⡎⠉⠁⡇⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⣦⠀⠀⠀⠀⠀⠓⠑⠙⠒⠊⠒⠀⠀⠱⠤⠤⠴⠘⠀⠀⠘⠊⠀⠠⠃⠇⠀⠘⠊⠓⠒⠑⠙⠊⠀⠀⠀⣐⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣄⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⡼⠑⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠉⠙⠰⠔⠔⠔⠔⠔⠔⠔⠔⠔⠴⠰⠔⢴⣄⠀⠀⠀⢀⡴⠢⠆⠦⠢⠢⠢⠉⠙⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡸⠀⢀⡴⠢⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⡞⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡴⢏⡽⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⢁⠢⡇⠀⠀⠀⢀⣀⡤⠦⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠂⢼⠁⠀⣠⠞⠌⢄⢱⡵⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠡⣹⢠⢞⠑⡈⣶⠊⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⢂⢺⢋⢂⢢⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡰⡖⠖⢖⠖⢞⠳⣔⢔⡐⡼⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⢶⠫⡨⠨⡊⡢⡑⠅⢕⢐⠅⡍⡻⢦⣄⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⢏⠢⡑⢌⢊⠢⡂⠎⢜⢐⠅⢕⠰⡨⠢⡩⡙⡲⡦⡄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢨⢎⠢⡑⢌⢢⠡⡑⢌⠪⡸⣾⣏⠢⡑⢌⢌⠢⡊⠔⡌⡾⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⠯⡪⡪⡨⠢⡑⢌⠜⡐⡑⢌⠫⡣⡑⢌⠆⡢⡑⢌⠪⣸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡴⠞⢜⠨⡘⢜⢜⢌⢌⠢⡑⡌⢜⢐⢑⠔⢌⠢⡑⢔⢡⣅⡯⠫⡇⠀⢀⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⢀⡤⡦⡻⡰⠨⡊⡢⡑⢌⠢⡑⢕⢕⢱⠨⡂⠕⢌⠢⡑⢅⢕⣜⡖⠟⢀⠂⣌⡇⠀⣸⡺⡪⠫⡯⡯⢯⢧⢶⢴⢦⣄⣄⣄⣄⡄⠀⠀⠀⠀
⠀⠀⠀⠀⣠⡖⢝⢍⠪⡐⡱⡑⡕⡨⢂⢊⠢⡑⢌⠢⡑⢅⢇⠪⡘⢔⢑⡼⣾⢉⠄⡀⣦⣔⡞⠑⠀⢀⣗⣝⢮⢯⢲⢴⢜⣎⣌⢎⣕⠕⡳⣕⢗⢽⢽⡝⠀⠀
⠀⡀⡴⡫⡂⡪⡐⢔⢑⢌⠢⡱⡱⡨⠢⡡⢃⢊⠢⡑⢌⠆⡢⡑⢌⢢⢽⡇⠈⠉⠉⠉⠁⠀⠀⠀⠀⣲⣣⡳⣳⠲⣲⡪⣱⡳⣨⣱⢱⢝⣝⢮⣫⡳⣳⠃⠀⠀
⢖⠍⡌⢎⢎⠢⡊⡢⡑⢔⢑⠔⡡⢣⢱⠨⠢⡡⢃⢊⠢⡑⢔⢡⡷⠪⠁⡇⠀⠀⠀⠀⠀⠀⠀⠀⢀⢼⣪⡺⣪⡲⡮⡬⡬⣘⡊⡮⡫⡃⡗⣗⢵⢽⡪⠀⠀⠀
⠢⡑⢌⢜⢸⢨⢂⠆⡊⡢⠢⡑⢌⢊⠢⡃⠕⢌⢢⠡⣃⡪⢮⠫⠈⡀⣢⠇⠀⠀⠀⠀⠀⠀⠀⡀⡸⠷⣗⣝⡮⡮⡳⣝⢞⢮⢮⡫⡮⡳⣕⣗⣝⡞⠀⠀⠀⠀
⡑⢌⠆⡢⠢⡑⡢⡑⢌⠢⡑⢌⢢⠡⡑⢌⣪⣢⠵⠽⠃⡁⢂⠠⢁⡴⠅⠀⠀⢀⣀⠤⠤⠜⠊⠬⡸⡸⡜⡜⡭⣛⢟⡳⡽⡵⣳⣝⡮⡯⡺⣜⢮⠃⠀⠀⠀⠀
⠷⢵⣨⣢⣱⣨⡂⣊⢢⢑⣌⣆⣵⠮⠞⠝⠠⠐⢀⠂⡁⠄⢂⣴⠃⠀⠀⠀⠸⢻⣦⣧⣦⣂⣂⠐⡈⠠⠘⠘⡈⠎⠎⢎⢎⢎⢎⢎⠎⡋⣋⣾⡝⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢺⡈⠩⠑⢉⠩⢁⠐⡀⢂⢐⢀⢂⠨⡀⢄⣄⡲⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠙⠟⢷⢶⢮⣂⣄⢂⢈⠄⠂⡁⣑⣄⢶⠻⠊⠁⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠳⠒⠓⠆⣆⣄⢦⠖⠊⠉⠉⠉⠉⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠛⠻⡷⡶⡞⠋⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
*/

#pragma once

#include "CoreMinimal.h"
#include "Components/ActorComponent.h"
#include "Components/SphereComponent.h"
#include "AutoGripComponent.generated.h"

UENUM(BlueprintType)
enum class EGripState : uint8
{
    Open,
    Gripping,
    Closed
};

UENUM(BlueprintType)
enum class EGripHand : uint8
{
    Left,
    Right
};

DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FOnItemGripped, AActor*, GrippedActor);
DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FOnItemReleased, AActor*, ReleasedActor);

UCLASS(ClassGroup=(Custom), meta=(BlueprintSpawnableComponent))
class MVE_API UAutoGripComponent : public UActorComponent
{
    GENERATED_BODY()

public:
    UAutoGripComponent();
    virtual void BeginPlay() override;
    virtual void EndPlay(const EEndPlayReason::Type EndPlayReason) override;

    // 왼손/오른손 선택
    UPROPERTY(EditAnywhere, Category = "Grip")
    EGripHand HandSide = EGripHand::Right;

    // 감지할 아이템 태그
    UPROPERTY(EditAnywhere, Category = "Grip")
    FName GrippableTag = TEXT("Grippable");

    // 붙일 소켓 이름
    UPROPERTY(EditAnywhere, Category = "Grip")
    FName GripSocketName = TEXT("hand_r_socket");

    // 감지 반경
    UPROPERTY(EditAnywhere, Category = "Grip")
    float DetectionRadius = 15.f;

    // 타이머 체크 간격
    UPROPERTY(EditAnywhere, Category = "Grip")
    float CheckInterval = 0.05f;

    // 그립 판정 임계값
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Grip")
    float GripThreshold = 0.4f;

    // 릴리스 판정 임계값
    UPROPERTY(EditAnywhere, BlueprintReadWrite, Category = "Grip")
    float ReleaseThreshold = 0.7f;

    // 아이템 잡았을 때 델리게이트
    UPROPERTY(BlueprintAssignable, Category = "Events")
    FOnItemGripped OnItemGripped;

    // 아이템 놓았을 때 델리게이트
    UPROPERTY(BlueprintAssignable, Category = "Events")
    FOnItemReleased OnItemReleased;

    // BP에서 Control Transform 업데이트 (개별 호출)
    UFUNCTION(BlueprintCallable, Category = "Grip")
    void UpdateControlTransform(int32 ControlIndex, const FTransform& InTransform, const FName& ControlName);

    // 현재 그립 상태 반환
    UFUNCTION(BlueprintPure, Category = "Grip")
    EGripState GetCurrentGripState() const { return CurrentGripState; }

    // 현재 그립 값 반환 (0~1)
    UFUNCTION(BlueprintPure, Category = "Grip")
    float GetCurrentGripValue() const { return CurrentGripValue; }

    // 잡고 있는 아이템 반환
    UFUNCTION(BlueprintPure, Category = "Grip")
    AActor* GetGrippedItem() const { return GrippedItem; }

    // 강제로 아이템 놓기
    UFUNCTION(BlueprintCallable, Category = "Grip")
    void ForceRelease();

    // 강제로 특정 아이템 잡기
    UFUNCTION(BlueprintCallable, Category = "Grip")
    void ForceGrip(AActor* ItemToGrip);

protected:
    UPROPERTY()
    USkeletalMeshComponent* OwnerMesh;

    UPROPERTY()
    USphereComponent* DetectionSphere;

    UPROPERTY()
    AActor* GrippedItem;

    UPROPERTY()
    TArray<AActor*> OverlapCandidates;

    // Control 이름 → Transform 매핑
    TMap<FName, FTransform> ControlTransformMap;

    EGripState CurrentGripState = EGripState::Open;
    float CurrentGripValue = 0.f;

    FTimerHandle GripCheckTimerHandle;
    bool bIsTimerActive = false;

    // 손가락 본 이름 (자동 설정)
    FName IndexBoneNames[3];
    FName MiddleBoneNames[3];
    FName RingBoneNames[3];
    FName PinkyBoneNames[3];
    FName WristBoneName;

    // 본 이름 초기화
    void InitializeBoneNames();

    // 감지용 Sphere 세팅
    void SetupDetectionSphere();

    UFUNCTION()
    void OnDetectionBeginOverlap(UPrimitiveComponent* OverlappedComp, AActor* OtherActor,
        UPrimitiveComponent* OtherComp, int32 OtherBodyIndex,
        bool bFromSweep, const FHitResult& SweepResult);

    UFUNCTION()
    void OnDetectionEndOverlap(UPrimitiveComponent* OverlappedComp, AActor* OtherActor,
        UPrimitiveComponent* OtherComp, int32 OtherBodyIndex);

    void StartGripCheckTimer();
    void StopGripCheckTimer();
    void OnGripCheckTimer();

    // 본 이름 기반 그립 값 계산
    float CalculateGripValue() const;

    // 단일 손가락 굽힘 계산
    float CalculateFingerCurl(const FName* FingerBoneNames) const;

    // Control 이름으로 Transform 가져오기
    FTransform GetControlTransform(const FName& BoneName) const;

    void UpdateGripState();
    void TryAttachItem(AActor* Item);
    void DetachCurrentItem();
    bool IsValidGrippableItem(AActor* Actor) const;


};  